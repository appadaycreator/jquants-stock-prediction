# jQuants認証管理システム（最終版）ガイド

## 概要

IDトークンを環境変数に設定せず、一時保存のみで管理するセキュアな認証システムです。

## 特徴

### 🔒 セキュリティ強化
- **IDトークンを環境変数に保存しない**: トークンの永続化を避ける
- **一時保存のみ**: トークンは一時キャッシュファイルのみに保存
- **自動クリーンアップ**: 不要なトークンの自動削除

### 🔄 自動再認証
- **一時保存されたトークンの自動管理**: 有効性チェックと自動更新
- **トークン無効時の自動再認証**: メールアドレスとパスワードで再取得
- **複数認証方法の自動切り替え**: IDトークン → リフレッシュ → 新規認証

### 🛡️ 堅牢性
- **自動リトライ機能**: 最大3回の再試行
- **詳細なエラーハンドリング**: 具体的なエラー情報の提供
- **トークン有効期限の自動チェック**: JWTトークンの有効期限検証

## ファイル構成

```
scripts/
├── jquants_auth_manager_final.py    # 最終版認証管理クラス
├── setup_auth_final.py              # 認証情報設定ツール
├── demo_auth_final.py               # 機能デモスクリプト
└── sync_with_jquants_api.py         # API同期スクリプト（更新済み）

data/
└── temp_token_cache.json           # 一時トークンキャッシュ（自動生成）
```

## 使用方法

### 1. 認証情報の設定

```bash
# 認証情報設定（IDトークンは設定しない）
python scripts/setup_auth_final.py
```

### 2. 機能デモの実行

```bash
# 認証管理機能のデモ
python scripts/demo_auth_final.py
```

### 3. API同期の実行

```bash
# テスト用同期
python scripts/sync_with_jquants_api.py --test

# 全銘柄同期
python scripts/sync_with_jquants_api.py
```

## 認証フロー

### 1. 初期認証
```
メールアドレス + パスワード
    ↓
リフレッシュトークン取得
    ↓
IDトークン取得
    ↓
一時キャッシュに保存（環境変数には保存しない）
```

### 2. トークン更新
```
一時キャッシュからトークン読み込み
    ↓
有効性チェック
    ↓
無効な場合: リフレッシュトークンで更新
    ↓
それでも無効: メールアドレスとパスワードで再認証
```

### 3. セキュリティ
```
トークンは一時保存のみ
    ↓
環境変数には保存しない
    ↓
セッション終了時に自動クリーンアップ
```

## 環境変数設定

### 必要な環境変数
```bash
# .envファイル
JQUANTS_EMAIL=your_email@example.com
JQUANTS_PASSWORD=your_password
```

### 設定しない環境変数
```bash
# 以下の環境変数は設定しない（一時保存のみ）
# JQUANTS_ID_TOKEN=        # 設定しない
# JQUANTS_REFRESH_TOKEN=   # 設定しない
```

## 一時トークンキャッシュ

### キャッシュファイル
- **場所**: `data/temp_token_cache.json`
- **内容**: IDトークン、リフレッシュトークン、有効期限
- **管理**: 自動生成・更新・クリーンアップ

### キャッシュ構造
```json
{
  "id_token": "eyJ...",
  "refresh_token": "eyJ...",
  "cached_at": "2025-10-04T07:47:51.801436",
  "expires_at": "2025-10-04T08:47:51.801436"
}
```

## エラーハンドリング

### 認証エラー
- **HTTP 400**: 認証情報が無効
- **HTTP 401**: トークンが無効
- **ネットワークエラー**: 接続失敗

### 自動復旧
- **リトライ機能**: 最大3回の再試行
- **認証方法の切り替え**: 複数の認証方法を自動試行
- **詳細ログ**: エラー原因の特定

## セキュリティ考慮事項

### 1. トークンの永続化を避ける
- 環境変数にIDトークンを保存しない
- 一時キャッシュのみで管理
- セッション終了時の自動クリーンアップ

### 2. 認証情報の保護
- メールアドレスとパスワードのみ環境変数に保存
- トークンは一時保存のみ
- 不要なトークンの自動削除

### 3. アクセス制御
- 一時キャッシュファイルの適切な権限設定
- ログファイルのセキュリティ
- 認証情報の漏洩防止

## トラブルシューティング

### よくある問題

#### 1. 認証エラー（HTTP 400）
```
原因: 認証情報が無効
解決: 正しいメールアドレスとパスワードを設定
```

#### 2. トークン取得失敗
```
原因: ネットワークエラーまたはAPI制限
解決: リトライ機能が自動実行される
```

#### 3. 一時キャッシュエラー
```
原因: ファイル権限またはディスク容量不足
解決: data/ディレクトリの権限確認
```

### デバッグ方法

#### 1. ログの確認
```bash
# 詳細ログの確認
tail -f jquants.log
```

#### 2. 一時キャッシュの確認
```bash
# キャッシュファイルの内容確認
cat data/temp_token_cache.json
```

#### 3. 認証テスト
```bash
# 認証機能のテスト
python scripts/demo_auth_final.py
```

## 更新履歴

### v1.0（最終版）
- IDトークンを環境変数に設定しない仕様に変更
- 一時保存のみでのトークン管理
- セキュリティ強化
- 自動再認証機能の完全実装

## まとめ

最終版認証管理システムは、セキュリティを重視した設計で、IDトークンを環境変数に保存せず、一時保存のみで管理します。これにより、トークンの永続化を避け、セキュリティを向上させています。

実際のjQuants APIを使用するには、正しい認証情報を設定し、システムを実行してください。
