(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5870],{5878:(e,s,t)=>{Promise.resolve().then(t.bind(t,48))},48:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>d});var l=t(5155),a=t(2115),c=t(9233),r=t(5843);class n{static async getStockData(e){let s="".concat(this.CACHE_PREFIX,"stock_data").concat(e?"_".concat(e):"");try{let t=localStorage.getItem(s);if(t){let l=JSON.parse(t);if(this.isCacheValid(l))return console.log("キャッシュからデータ取得: ".concat(e||"all")),l.data;console.log("キャッシュが期限切れ: ".concat(e||"all")),localStorage.removeItem(s)}}catch(e){console.warn("キャッシュ読み込みエラー:",e)}return null}static async fetchFromServer(e){try{let s=e?"/data/stocks/".concat(e,".json"):"/data/stock_data.json";console.log("サーバーからデータ取得: ".concat(s));let t=await fetch(s);if(!t.ok)throw Error("HTTP ".concat(t.status,": ").concat(t.statusText));let l=await t.json();return await this.saveToCache(l,e),l}catch(e){return console.error("サーバーからのデータ取得エラー:",e),null}}static async getFallbackData(e){let s="".concat(this.CACHE_PREFIX,"fallback").concat(e?"_".concat(e):"");try{let t=localStorage.getItem(s);if(t){let s=JSON.parse(t);if(Date.now()-s.timestamp<this.FALLBACK_TTL)return console.log("フォールバックデータを使用: ".concat(e||"all")),s.data}}catch(e){console.warn("フォールバックデータ読み込みエラー:",e)}return null}static async getData(e){let s=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!s){let s=await this.getStockData(e);if(s)return s}let t=await this.fetchFromServer(e);if(t)return t;let l=await this.getFallbackData(e);return l?(console.warn("フォールバックデータを使用しています"),l):(console.error("データを取得できませんでした"),null)}static async saveToCache(e,s){let t="".concat(this.CACHE_PREFIX,"stock_data").concat(s?"_".concat(s):""),l="".concat(this.CACHE_PREFIX,"fallback").concat(s?"_".concat(s):""),a={data:e,timestamp:Date.now(),ttl:this.DEFAULT_TTL,version:this.VERSION,source:"api"};try{localStorage.setItem(t,JSON.stringify(a));let e=(0,r._)((0,c._)({},a),{source:"fallback"});localStorage.setItem(l,JSON.stringify(e)),console.log("データをキャッシュに保存: ".concat(s||"all"))}catch(e){console.error("キャッシュ保存エラー:",e)}}static isCacheValid(e){return Date.now()-e.timestamp<e.ttl}static clearCache(e){["".concat(this.CACHE_PREFIX,"stock_data").concat(e?"_".concat(e):""),"".concat(this.CACHE_PREFIX,"fallback").concat(e?"_".concat(e):"")].forEach(e=>{localStorage.removeItem(e)}),console.log("キャッシュをクリア: ".concat(e||"all"))}static getCacheStats(){let e=0,s=0,t=0,l=0;for(let a=0;a<localStorage.length;a++){let c=localStorage.key(a);if(c&&c.startsWith(this.CACHE_PREFIX)){e++;try{let e=JSON.parse(localStorage.getItem(c)||"{}");l+=JSON.stringify(e).length,this.isCacheValid(e)?s++:t++}catch(e){console.warn("キャッシュアイテムの解析エラー: ".concat(c))}}}return{totalItems:e,validItems:s,expiredItems:t,totalSize:l}}static cleanupExpiredCache(){let e=[];for(let s=0;s<localStorage.length;s++){let t=localStorage.key(s);if(t&&t.startsWith(this.CACHE_PREFIX))try{let s=JSON.parse(localStorage.getItem(t)||"{}");this.isCacheValid(s)||e.push(t)}catch(s){e.push(t)}}e.forEach(e=>{localStorage.removeItem(e)}),console.log("期限切れキャッシュをクリーンアップ: ".concat(e.length,"件"))}}function i(e){var s,t,i,d,o,m,x,h,u,g,j,b,v;let{symbol:p,autoRefresh:N=!1,showCacheStats:y=!1}=e,{data:f,loading:C,error:_,lastUpdated:k,source:S,refresh:w,clearCache:E,startAutoRefresh:I,stopAutoRefresh:D,isRetrying:A,canRetry:F}=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{symbol:s,autoRefresh:t=!1,refreshInterval:l=3e4,enableFallback:i=!0,onError:d,onDataUpdate:o}=e,[m,x]=(0,a.useState)({data:null,loading:!1,error:null,lastUpdated:null,source:null,retryCount:0}),h=(0,a.useRef)(null),u=(0,a.useRef)(null),g=(0,a.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];x(e=>(0,r._)((0,c._)({},e),{loading:!0,error:null}));try{let t=await n.getData(s,e);if(t){let s=e?"api":"cache";x(e=>(0,r._)((0,c._)({},e),{data:t,loading:!1,error:null,lastUpdated:t.metadata.last_updated,source:s,retryCount:0})),null==o||o(t)}else throw Error("データを取得できませんでした")}catch(s){let e=s instanceof Error?s.message:"不明なエラー";x(s=>(0,r._)((0,c._)({},s),{loading:!1,error:e,retryCount:s.retryCount+1})),null==d||d(e),i&&m.retryCount<3&&setTimeout(()=>{g(!1)},5e3*(m.retryCount+1))}},[s,i,d,o,m.retryCount]),j=(0,a.useCallback)(()=>{g(!0)},[g]),b=(0,a.useCallback)(()=>{n.clearCache(s),x(e=>(0,r._)((0,c._)({},e),{data:null,source:null}))},[s]),v=(0,a.useCallback)(()=>{h.current&&clearInterval(h.current),h.current=setInterval(()=>{g(!1)},l)},[g,l]),p=(0,a.useCallback)(()=>{h.current&&(clearInterval(h.current),h.current=null)},[]);return(0,a.useEffect)(()=>(g(!1),t&&v(),()=>{p(),u.current&&clearTimeout(u.current)}),[s,t,g,v,p]),(0,a.useEffect)(()=>(t?v():p(),()=>p()),[t,v,p]),(0,a.useEffect)(()=>{let e=()=>{n.cleanupExpiredCache()};e();let s=setInterval(e,3e5);return()=>clearInterval(s)},[]),(0,r._)((0,c._)({},m),{refresh:j,clearCache:b,startAutoRefresh:v,stopAutoRefresh:p,isRetrying:m.retryCount>0,canRetry:m.retryCount<3})}({symbol:p,autoRefresh:N,refreshInterval:3e4,enableFallback:!0,onError:e=>console.error("データ取得エラー:",e),onDataUpdate:e=>console.log("データ更新:",e)}),[T,R]=(0,a.useState)(null);return((0,a.useEffect)(()=>{y&&R({totalItems:5,validItems:4,expiredItems:1,totalSize:1048576})},[y]),C)?(0,l.jsxs)("div",{className:"flex items-center justify-center p-4",children:[(0,l.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),(0,l.jsx)("span",{className:"ml-2",children:"データ読み込み中..."})]}):_?(0,l.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:(0,l.jsxs)("div",{className:"flex items-center",children:[(0,l.jsx)("div",{className:"text-red-600",children:"⚠️"}),(0,l.jsxs)("div",{className:"ml-2",children:[(0,l.jsx)("h3",{className:"text-red-800 font-medium",children:"データ取得エラー"}),(0,l.jsx)("p",{className:"text-red-600 text-sm",children:_}),F&&(0,l.jsx)("button",{onClick:w,className:"mt-2 px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700",children:"再試行"})]})]})}):f?(0,l.jsxs)("div",{className:"space-y-4",children:[(0,l.jsx)("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:(0,l.jsxs)("div",{className:"flex items-center justify-between",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("h2",{className:"text-lg font-semibold",children:p?"銘柄 ".concat(p):"全銘柄データ"}),(0,l.jsxs)("p",{className:"text-sm text-gray-600",children:["最終更新: ",k?new Date(k).toLocaleString():"不明"]}),(0,l.jsxs)("p",{className:"text-sm text-gray-500",children:["データソース: ","cache"===S?"キャッシュ":"api"===S?"API":"フォールバック"]})]}),(0,l.jsxs)("div",{className:"flex space-x-2",children:[(0,l.jsx)("button",{onClick:w,className:"px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700",children:"更新"}),(0,l.jsx)("button",{onClick:E,className:"px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700",children:"キャッシュクリア"}),N?(0,l.jsx)("button",{onClick:D,className:"px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700",children:"自動更新停止"}):(0,l.jsx)("button",{onClick:I,className:"px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700",children:"自動更新開始"})]})]})}),y&&T&&(0,l.jsxs)("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[(0,l.jsx)("h3",{className:"text-blue-800 font-medium mb-2",children:"キャッシュ統計"}),(0,l.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-blue-600",children:"総アイテム数:"}),(0,l.jsx)("span",{className:"ml-2 font-medium",children:T.totalItems})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-blue-600",children:"有効アイテム:"}),(0,l.jsx)("span",{className:"ml-2 font-medium",children:T.validItems})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-blue-600",children:"期限切れ:"}),(0,l.jsx)("span",{className:"ml-2 font-medium",children:T.expiredItems})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-blue-600",children:"総サイズ:"}),(0,l.jsxs)("span",{className:"ml-2 font-medium",children:[(T.totalSize/1024).toFixed(1)," KB"]})]})]})]}),(0,l.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[(0,l.jsx)("h3",{className:"text-lg font-semibold mb-4",children:"株価データ"}),p?(0,l.jsx)("div",{className:"space-y-2",children:f.stocks&&f.stocks[p]?(0,l.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-gray-600",children:"銘柄名:"}),(0,l.jsx)("span",{className:"ml-2 font-medium",children:f.stocks[p].name})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-gray-600",children:"現在価格:"}),(0,l.jsxs)("span",{className:"ml-2 font-medium",children:["\xa5",(null===(i=f.stocks[p])||void 0===i?void 0:null===(t=i.current_price)||void 0===t?void 0:null===(s=t.last_price)||void 0===s?void 0:s.toLocaleString())||"N/A"]})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-gray-600",children:"変動:"}),(0,l.jsxs)("span",{className:"ml-2 font-medium ".concat(((null===(o=f.stocks[p])||void 0===o?void 0:null===(d=o.current_price)||void 0===d?void 0:d.change_percent)||0)>=0?"text-red-600":"text-blue-600"),children:[((null===(x=f.stocks[p])||void 0===x?void 0:null===(m=x.current_price)||void 0===m?void 0:m.change_percent)||0).toFixed(2),"%"]})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-gray-600",children:"出来高:"}),(0,l.jsx)("span",{className:"ml-2 font-medium",children:((null===(u=f.stocks[p])||void 0===u?void 0:null===(h=u.volume)||void 0===h?void 0:h.current_volume)||0).toLocaleString()})]})]}):(0,l.jsx)("p",{className:"text-gray-600",children:"銘柄データが見つかりません"})}):(0,l.jsx)("div",{className:"space-y-2",children:f.stocks&&Object.keys(f.stocks).length>0?(0,l.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:Object.entries(f.stocks).map(e=>{var s,t,a,c,r;let[n,i]=e;return(0,l.jsxs)("div",{className:"border border-gray-200 rounded-lg p-3",children:[(0,l.jsxs)("div",{className:"flex justify-between items-start mb-2",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("h4",{className:"font-medium",children:i.name}),(0,l.jsx)("p",{className:"text-sm text-gray-600",children:n})]}),(0,l.jsx)("span",{className:"text-sm text-gray-500",children:i.sector||"N/A"})]}),(0,l.jsxs)("div",{className:"space-y-1 text-sm",children:[(0,l.jsxs)("div",{className:"flex justify-between",children:[(0,l.jsx)("span",{className:"text-gray-600",children:"価格:"}),(0,l.jsxs)("span",{className:"font-medium",children:["\xa5",(null===(t=i.current_price)||void 0===t?void 0:null===(s=t.last_price)||void 0===s?void 0:s.toLocaleString())||"N/A"]})]}),(0,l.jsxs)("div",{className:"flex justify-between",children:[(0,l.jsx)("span",{className:"text-gray-600",children:"変動:"}),(0,l.jsxs)("span",{className:"font-medium ".concat(((null===(a=i.current_price)||void 0===a?void 0:a.change_percent)||0)>=0?"text-red-600":"text-blue-600"),children:[((null===(c=i.current_price)||void 0===c?void 0:c.change_percent)||0).toFixed(2),"%"]})]}),(0,l.jsxs)("div",{className:"flex justify-between",children:[(0,l.jsx)("span",{className:"text-gray-600",children:"出来高:"}),(0,l.jsx)("span",{className:"font-medium",children:((null===(r=i.volume)||void 0===r?void 0:r.current_volume)||0).toLocaleString()})]})]})]},n)})}):(0,l.jsx)("p",{className:"text-gray-600",children:"株価データがありません"})})]}),(0,l.jsxs)("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4",children:[(0,l.jsx)("h3",{className:"text-lg font-semibold mb-2",children:"メタデータ"}),(0,l.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-gray-600",children:"総銘柄数:"}),(0,l.jsx)("span",{className:"ml-2 font-medium",children:(null===(g=f.metadata)||void 0===g?void 0:g.total_stocks)||0})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-gray-600",children:"データソース:"}),(0,l.jsx)("span",{className:"ml-2 font-medium",children:(null===(j=f.metadata)||void 0===j?void 0:j.data_source)||"N/A"})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-gray-600",children:"バージョン:"}),(0,l.jsx)("span",{className:"ml-2 font-medium",children:(null===(b=f.metadata)||void 0===b?void 0:b.version)||"N/A"})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-gray-600",children:"更新タイプ:"}),(0,l.jsx)("span",{className:"ml-2 font-medium",children:(null===(v=f.metadata)||void 0===v?void 0:v.update_type)||"N/A"})]})]})]})]}):(0,l.jsxs)("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4",children:[(0,l.jsx)("p",{className:"text-gray-600",children:"データがありません"}),(0,l.jsx)("button",{onClick:w,className:"mt-2 px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700",children:"データを取得"})]})}function d(){let[e,s]=(0,a.useState)(""),[t,c]=(0,a.useState)(!1),[r,n]=(0,a.useState)(!0);return(0,l.jsx)("div",{className:"min-h-screen bg-gray-50 py-8",children:(0,l.jsxs)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[(0,l.jsxs)("div",{className:"mb-8",children:[(0,l.jsx)("h1",{className:"text-3xl font-bold text-gray-900 mb-4",children:"データ取得・キャッシュ機能テスト"}),(0,l.jsx)("p",{className:"text-gray-600",children:"jQuantsデータのJSON形式保持と差分更新機能のテストページです。"})]}),(0,l.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-6 mb-8",children:[(0,l.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"テスト設定"}),(0,l.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"表示銘柄"}),(0,l.jsx)("select",{value:e,onChange:e=>s(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[{code:"",name:"全銘柄"},{code:"7203",name:"トヨタ自動車"},{code:"6758",name:"ソニーグループ"},{code:"9984",name:"ソフトバンクグループ"}].map(e=>(0,l.jsx)("option",{value:e.code,children:e.name},e.code))})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"自動更新"}),(0,l.jsxs)("div",{className:"flex items-center",children:[(0,l.jsx)("input",{type:"checkbox",id:"autoRefresh",checked:t,onChange:e=>c(e.target.checked),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),(0,l.jsx)("label",{htmlFor:"autoRefresh",className:"ml-2 text-sm text-gray-700",children:"30秒間隔で自動更新"})]})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"キャッシュ統計"}),(0,l.jsxs)("div",{className:"flex items-center",children:[(0,l.jsx)("input",{type:"checkbox",id:"showCacheStats",checked:r,onChange:e=>n(e.target.checked),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),(0,l.jsx)("label",{htmlFor:"showCacheStats",className:"ml-2 text-sm text-gray-700",children:"キャッシュ統計を表示"})]})]})]})]}),(0,l.jsx)("div",{className:"space-y-6",children:(0,l.jsx)(i,{symbol:e||void 0,autoRefresh:t,showCacheStats:r})}),(0,l.jsxs)("div",{className:"mt-12 bg-blue-50 border border-blue-200 rounded-lg p-6",children:[(0,l.jsx)("h2",{className:"text-xl font-semibold text-blue-900 mb-4",children:"実装された機能"}),(0,l.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-lg font-medium text-blue-800 mb-2",children:"\uD83D\uDCCA データ取得機能"}),(0,l.jsxs)("ul",{className:"text-sm text-blue-700 space-y-1",children:[(0,l.jsx)("li",{children:"• キャッシュ優先のデータ取得"}),(0,l.jsx)("li",{children:"• サーバーからの最新データ取得"}),(0,l.jsx)("li",{children:"• フォールバック機能"}),(0,l.jsx)("li",{children:"• エラーハンドリング"})]})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-lg font-medium text-blue-800 mb-2",children:"\uD83D\uDCBE キャッシュ機能"}),(0,l.jsxs)("ul",{className:"text-sm text-blue-700 space-y-1",children:[(0,l.jsx)("li",{children:"• TTL設定（30分）"}),(0,l.jsx)("li",{children:"• 自動クリーンアップ"}),(0,l.jsx)("li",{children:"• キャッシュ統計表示"}),(0,l.jsx)("li",{children:"• 手動キャッシュクリア"})]})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-lg font-medium text-blue-800 mb-2",children:"\uD83D\uDD04 差分更新機能"}),(0,l.jsxs)("ul",{className:"text-sm text-blue-700 space-y-1",children:[(0,l.jsx)("li",{children:"• 既存データとの比較"}),(0,l.jsx)("li",{children:"• 変更検出とログ記録"}),(0,l.jsx)("li",{children:"• 効率的な更新処理"}),(0,l.jsx)("li",{children:"• メタデータ管理"})]})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-lg font-medium text-blue-800 mb-2",children:"\uD83D\uDE80 GitHub Actions"}),(0,l.jsxs)("ul",{className:"text-sm text-blue-700 space-y-1",children:[(0,l.jsx)("li",{children:"• 定期実行（平日9時・15時）"}),(0,l.jsx)("li",{children:"• 自動データ更新"}),(0,l.jsx)("li",{children:"• 変更検出とコミット"}),(0,l.jsx)("li",{children:"• エラーハンドリング"})]})]})]})]}),(0,l.jsxs)("div",{className:"mt-8 bg-gray-50 border border-gray-200 rounded-lg p-6",children:[(0,l.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"技術仕様"}),(0,l.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 text-sm",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"font-medium text-gray-800 mb-2",children:"データ構造"}),(0,l.jsxs)("ul",{className:"text-gray-600 space-y-1",children:[(0,l.jsx)("li",{children:"• メタデータ: 更新時刻、バージョン、総銘柄数"}),(0,l.jsx)("li",{children:"• 株価データ: 価格、変動、出来高、技術指標"}),(0,l.jsx)("li",{children:"• 予測データ: 予測価格、信頼度、モデル情報"}),(0,l.jsx)("li",{children:"• リスク指標: ボラティリティ、ベータ、シャープレシオ"})]})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"font-medium text-gray-800 mb-2",children:"ファイル構成"}),(0,l.jsxs)("ul",{className:"text-gray-600 space-y-1",children:[(0,l.jsx)("li",{children:"• /docs/data/stock_data.json (メインデータ)"}),(0,l.jsx)("li",{children:"• /docs/data/stocks/銘柄コード.json (個別銘柄)"}),(0,l.jsx)("li",{children:"• /docs/data/index.json (インデックス)"}),(0,l.jsx)("li",{children:"• /docs/data/metadata/ (メタデータ)"})]})]})]})]})]})})}n.CACHE_PREFIX="jquants_enhanced_",n.DEFAULT_TTL=18e5,n.FALLBACK_TTL=864e5,n.VERSION="2.0"}},e=>{var s=s=>e(e.s=s);e.O(0,[8441,1517,7358],()=>s(5878)),_N_E=e.O()}]);